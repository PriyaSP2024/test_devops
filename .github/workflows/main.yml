name: CI/CD Pipeline
 
on:

  push:

    branches: [main]
 
jobs:

  build-and-deploy:

    runs-on: ubuntu-latest
 
    steps:

    - name: Checkout Code

      uses: actions/checkout@v3
 
    - name: Set up Python

      uses: actions/setup-python@v4

      with:

        python-version: '3.11'
 
    - name: Install dependencies

      run: |

        python -m pip install --upgrade pip

        pip install -r requirements.txt
 
    - name: Run SonarQube Analysis

      uses: sonarsource/sonarqube-scan-action@v2

      with:

        projectBaseDir: .

      env:

        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

        SONAR_HOST_URL: http://18.217.40.75:9000
 
    - name: Copy files to EC2 via SCP

      uses: appleboy/scp-action@master

      with:

        host: ${{ secrets.HOST }}

        username: ubuntu

        key: ${{ secrets.PRIVATE_KEY }}

        source: "."

        target: "/home/ubuntu/horilla"
 
    - name: SSH into EC2 and deploy

      uses: appleboy/ssh-action@master

      with:

        host: ${{ secrets.HOST }}

        username: ubuntu

        key: ${{ secrets.PRIVATE_KEY }}

        script: |

          cd horilla

          docker compose down

          docker compose up -d --build

 
